exports.ids=[2],exports.modules={388:function(e,t,a){"use strict";a.r(t),a.d(t,"CheckoutPageComponent",(function(){return oe}));var n=a(1),r=a.n(n),i=a(11),o=a.n(i),s=a(12),c=a.n(s),l=a(7),d=a.n(l),u=a(13),b=a.n(u),g=a(14),p=a.n(g),m=a(6),h=a(22),j=a(82),k=a(3),f=a(39),P=a(4),O=a.n(P),y=a(9),C=a(31),_=a(33),v=a(10),D=a(15),I=a(26),x=a(25),E=a(17),S=a(24),N=a(21),T=a(5),w=a(35),M=a(109),A=a(220),F=a(166),L=a(169),z=a(53),U=a.n(z),W=a(20),B=a.n(W),R=a(179),H=a.n(R),V=a(50),Y=a.n(V),J=a(23),q=J.c.UUID,K=J.c.Money,G=function(e,t){return H()(Object.entries(t),(function(t,a){var n=U()(a,2),r=n[0],i=n[1];return!(!Object.prototype.hasOwnProperty.call(e,r)||!i(e[r]))&&t}),!0)},Q=function(e,t,a,n,r){if(window&&window.sessionStorage&&a&&t&&e){var i={bookingData:e,bookingDates:t,listing:a,transaction:n,storedAt:new Date},o=JSON.stringify(i,(function(e,t){return this[e]instanceof Date?{date:t,_serializedType:"SerializableDate"}:this[e]instanceof Y.a?{decimal:t,_serializedType:"SerializableDecimal"}:J.c.replacer(e,t)}));window.sessionStorage.setItem(r,o)}},X=function(e){if(window&&window.sessionStorage){var t=window.sessionStorage.getItem(e),a=t?JSON.parse(t,(function(e,t){return t&&"object"===typeof t&&"SerializableDate"===t._serializedType?new Date(t.date):t&&"object"===typeof t&&"SerializableDecimal"===t._serializedType?new Y.a(t.decimal):J.c.reviver(e,t)})):{},n=a.bookingData,r=a.bookingDates,i=a.listing,o=a.transaction,s=a.storedAt,c=!!s&&B()(s).isAfter(B()().subtract(1,"days")),l=!o||function(e){return G(e,{id:function(e){return e instanceof q},type:function(e){return"transaction"===e},attributes:function(e){return"object"===typeof e&&N.a.includes(e.lastTransition)}})}(o),d=c&&function(e){return G(e,{bookingStart:function(e){return e instanceof Date},bookingEnd:function(e){return e instanceof Date}})}(r)&&function(e){return G(e,{id:function(e){return e instanceof q},attributes:function(e){return"object"===typeof e&&e.price instanceof K}})}(i)&&l;if(d)return{bookingData:n,bookingDates:r,listing:i,transaction:o}}return{}},Z=a(466),$=a.n(Z),ee=a(0),te="CheckoutPage",ae=["processing","requires_capture","succeeded"],ne="PAY_AND_SAVE_FOR_LATER_USE",re="USE_SAVED_CARD",ie=function(e){return!!Object(N.I)(e)||!!Object(N.J)(e)&&Object(I.k)(e.attributes.lastTransitionedAt,new Date)>=15},oe=function(e){b()(a,e);var t=p()(a);function a(e){var n;return o()(this,a),(n=t.call(this,e)).state={pageData:{},dataLoaded:!1,submitting:!1},n.stripe=null,n.onStripeInitialized=n.onStripeInitialized.bind(d()(n)),n.loadInitialData=n.loadInitialData.bind(d()(n)),n.handlePaymentIntent=n.handlePaymentIntent.bind(d()(n)),n.handleSubmit=n.handleSubmit.bind(d()(n)),n}return c()(a,[{key:"componentDidMount",value:function(){window&&this.loadInitialData()}},{key:"loadInitialData",value:function(){var e=this.props,t=e.bookingData,a=e.bookingDates,n=e.listing,r=e.transaction,i=e.fetchSpeculatedTransaction,o=e.fetchStripeCustomer,s=e.history;o();var c="PUSH"===s.action||"REPLACE"===s.action,l=!!(t&&a&&n)&&c;l&&Q(t,a,n,r,te);var d=l?{bookingData:t,bookingDates:a,listing:n,transaction:r}:X(te),u=d?d.transaction:null,b=u&&u.booking&&u.booking.id;if(d&&d.listing&&d.listing.id&&d.bookingData&&d.bookingDates&&d.bookingDates.bookingStart&&d.bookingDates.bookingEnd&&!b){var g=d.listing.id,p=u?u.id:null,m=d.bookingDates,h=m.bookingStart,j=m.bookingEnd;i({listingId:g,bookingStart:Object(I.d)(h),bookingEnd:Object(I.d)(j)},p)}this.setState({pageData:d||{},dataLoaded:!0})}},{key:"handlePaymentIntent",value:function(e){var t=this,a=this.props,n=a.currentUser,i=a.stripeCustomerFetched,o=a.onInitiateOrder,s=a.onConfirmCardPayment,c=a.onConfirmPayment,l=a.onSendMessage,d=a.onSavePaymentMethod,u=e.pageData,b=e.speculatedTransaction,g=e.message,p=e.paymentIntent,m=e.selectedPaymentMethod,h=e.saveAfterOnetimePayment,j=Object(D.l)(u.transaction),k=Object(D.e)(n),f=Object(D.j)(k.stripeCustomer),P=Object(D.i)(f.defaultPaymentMethod),O=null,y=!!(i&&f.attributes.stripeCustomerId&&P.id),C=y?P.attributes.stripePaymentMethodId:null,_=function(e,t){return"defaultCard"===e?re:t?ne:"ONETIME_PAYMENT"}(m,h),v=function(e,t){return e.then(t)},I=function(){for(var e=arguments.length,t=new Array(e),a=0;a<e;a++)t[a]=arguments[a];return function(e){return t.reduce(v,Promise.resolve(e))}}((function(e){return j.attributes.protectedData&&j.attributes.protectedData.stripePaymentIntents?Promise.resolve(j):o(e,j.id)}),(function(a){var n=Object(D.l)(a);if(n.id){var i=u.bookingData,o=u.bookingDates,c=u.listing;Q(i,o,c,n,te),t.setState({pageData:r()(r()({},u),{},{transaction:n})})}var l=n.attributes.protectedData&&n.attributes.protectedData.stripePaymentIntents;if(!l)throw new Error("Missing StripePaymentIntents key in transaction's protectedData. Check that your transaction process is configured to use payment intents.");var d=(l?n.attributes.protectedData.stripePaymentIntents.default:null).stripePaymentIntentClientSecret,b=e.stripe,g=e.card,p=e.billingDetails,m=e.paymentIntent,h=_!==re?{card:g}:{},j=_!==re?{payment_method:{billing_details:p,card:g}}:{},k=r()(r()({stripePaymentIntentClientSecret:d,orderId:n.id,stripe:b},h),{},{paymentParams:j});return m&&ae.includes(m.status)?Promise.resolve({transactionId:n.id,paymentIntent:m}):s(k)}),(function(e){return O=e.paymentIntent,c(e)}),(function(e){return l(r()(r()({},e),{},{message:g}))}),(function(e){return _===ne?d(f,(O||p).payment_method).then((function(t){return t.errors?r()(r()({},e),{},{paymentMethodSaved:!1}):r()(r()({},e),{},{paymentMethodSaved:!0})})).catch((function(t){return r()(r()({},e),{},{paymentMethodSaved:!1})})):Promise.resolve(r()(r()({},e),{},{paymentMethodSaved:!0}))})),x=b||j,E=_===re&&y?{paymentMethod:C}:_===ne?{setupPaymentMethodForSaving:!0}:{};return I(r()({listingId:u.listing.id,bookingStart:x.booking.attributes.start,bookingEnd:x.booking.attributes.end},E))}},{key:"handleSubmit",value:function(e){var t=this;if(!this.state.submitting){this.setState({submitting:!0});var a=this.props,n=a.history,i=a.speculatedTransaction,o=a.currentUser,s=a.paymentIntent,c=a.dispatch,l=e.card,d=e.message,u=e.paymentMethod,b=e.formValues,g=b.name,p=b.addressLine1,m=b.addressLine2,h=b.postal,j=b.city,k=b.state,f=b.country,P=b.saveAfterOnetimePayment,O=p&&h?{address:{city:j,country:f,line1:p,line2:m,postal_code:h,state:k}}:{},y=r()({name:g,email:Object(D.e)(o).attributes.email},O),v={pageData:this.state.pageData,speculatedTransaction:i,stripe:this.stripe,card:l,billingDetails:y,message:d,paymentIntent:s,selectedPaymentMethod:u,saveAfterOnetimePayment:!!P};this.handlePaymentIntent(v).then((function(e){var a=e.orderId,r=e.messageSuccess,i=e.paymentMethodSaved;t.setState({submitting:!1});var o,s=Object(C.b)(),l=r?null:a,d=Object(_.e)("OrderDetailsPage",s,{id:a.uuid});!function(e,t,a){a(Object(_.c)("OrderDetailsPage",t).setInitialValues(e))}({initialMessageFailedToTransaction:l,savePaymentMethodFailed:!i},s,c),o=te,window&&window.sessionStorage&&window.sessionStorage.removeItem(o),n.push(d)})).catch((function(e){console.error(e),t.setState({submitting:!1})}))}}},{key:"onStripeInitialized",value:function(e){this.stripe=e;var t=this.props,a=t.paymentIntent,n=t.onRetrievePaymentIntent,r=this.state.pageData?this.state.pageData.transaction:null;this.stripe&&!a&&r&&r.id&&r.booking&&r.booking.id&&Object(N.J)(r)&&!ie(r)&&n({stripe:e,stripePaymentIntentClientSecret:(r.attributes.protectedData&&r.attributes.protectedData.stripePaymentIntents?r.attributes.protectedData.stripePaymentIntents.default:{}).stripePaymentIntentClientSecret})}},{key:"render",value:function(){var e=this.props,t=e.scrollingDisabled,a=e.speculateTransactionInProgress,n=e.speculateTransactionError,i=e.speculatedTransaction,o=e.initiateOrderError,s=e.confirmPaymentError,c=e.intl,l=e.params,d=e.currentUser,u=e.confirmCardPaymentError,b=e.paymentIntent,g=e.retrievePaymentIntentError,p=e.stripeCustomerFetched,m=Object(E.k)(n)||Object(E.k)(o),h=!this.state.dataLoaded||a,j=this.state.pageData,f=j.listing,P=j.bookingDates,C=j.transaction,_=Object(D.l)(C),I=Object(D.l)(i,{},null),M=Object(D.g)(f),A=Object(D.m)(M.author),F=M.attributes.title,L=c.formatMessage({id:"CheckoutPage.title"},{listingTitle:F}),z={title:L,scrollingDisabled:t},U=Object(ee.jsx)("div",{className:$.a.topbar,children:Object(ee.jsxs)(T.Gb,{className:$.a.home,name:"LandingPage",children:[Object(ee.jsx)(T.wb,{className:$.a.logoMobile,title:c.formatMessage({id:"CheckoutPage.goToLandingPage"}),format:"mobile"}),Object(ee.jsx)(T.wb,{className:$.a.logoDesktop,alt:c.formatMessage({id:"CheckoutPage.goToLandingPage"}),format:"desktop"})]})});if(h)return Object(ee.jsx)(T.Kb,r()(r()({},z),{},{children:U}));var W=d&&d.id&&A&&A.id&&A.id.uuid===d.id.uuid,B=!(!M.id||!A.id),R=!!(P&&P.bookingStart&&P.bookingEnd),H=B&&R;if(!h&&!(H&&!W))return console.error("Missing or invalid data for checkout, redirecting back to listing page.",{transaction:I,bookingDates:P,listing:f}),Object(ee.jsx)(T.Hb,{name:"ListingPage",params:l});var V=_.booking?_:I,Y=Object(D.d)(V.booking),J=V.id&&Y.id?Object(ee.jsx)(T.f,{className:$.a.bookingBreakdown,userRole:"customer",unitType:y.a.bookingUnitType,transaction:V,booking:Y,dateType:v.a}):null,q=ie(_),K=!!(p&&Object(D.j)(d.stripeCustomer).attributes.stripeCustomerId&&Object(D.i)(d.stripeCustomer.defaultPaymentMethod).id),G=!(!d||!H||m||o||n||g||q),Q=M.images&&M.images.length>0?M.images[0]:null,X=Object(ee.jsx)(T.Gb,{name:"ListingPage",params:{id:M.id.uuid,slug:Object(x.f)(F)},children:Object(ee.jsx)(k.b,{id:"CheckoutPage.errorlistingLinkText"})}),Z=Object(E.i)(o),te=Object(E.h)(o),ne=Object(E.j)(o),re=Object(E.s)(o),oe=null,se=null;if(m)se=Object(ee.jsx)("p",{className:$.a.notFoundError,children:Object(ee.jsx)(k.b,{id:"CheckoutPage.listingNotFoundError"})});else if(Z)oe=Object(ee.jsx)("p",{className:$.a.orderError,children:Object(ee.jsx)(k.b,{id:"CheckoutPage.initiateOrderAmountTooLow"})});else if(ne)oe=Object(ee.jsx)("p",{className:$.a.orderError,children:Object(ee.jsx)(k.b,{id:"CheckoutPage.bookingTimeNotAvailableMessage"})});else if(te)oe=Object(ee.jsx)("p",{className:$.a.orderError,children:Object(ee.jsx)(k.b,{id:"CheckoutPage.chargeDisabledMessage"})});else if(re&&re.length>0){var ce=re.join(", ");oe=Object(ee.jsx)("p",{className:$.a.orderError,children:Object(ee.jsx)(k.b,{id:"CheckoutPage.initiateOrderStripeError",values:{stripeErrors:ce}})})}else o&&(oe=Object(ee.jsx)("p",{className:$.a.orderError,children:Object(ee.jsx)(k.b,{id:"CheckoutPage.initiateOrderError",values:{listingLink:X}})}));var le=n?Object(ee.jsx)("p",{className:$.a.speculateError,children:Object(ee.jsx)(k.b,{id:"CheckoutPage.speculateTransactionError"})}):null,de=null;Object(E.l)(n)?de=Object(ee.jsx)("p",{className:$.a.orderError,children:Object(ee.jsx)(k.b,{id:"CheckoutPage.providerStripeAccountMissingError"})}):Object(E.j)(n)?de=Object(ee.jsx)("p",{className:$.a.orderError,children:Object(ee.jsx)(k.b,{id:"CheckoutPage.bookingTimeNotAvailableMessage"})}):Object(E.m)(n)?de=Object(ee.jsx)("p",{className:$.a.orderError,children:Object(ee.jsx)(k.b,{id:"CheckoutPage.initiateOrderAmountTooLow"})}):n&&(de=Object(ee.jsx)("p",{className:$.a.orderError,children:Object(ee.jsx)(k.b,{id:"CheckoutPage.speculateFailedMessage"})}));var ue=y.a.bookingUnitType,be=ue===v.s,ge=ue===v.r,pe=be?"CheckoutPage.perNight":ge?"CheckoutPage.perDay":"CheckoutPage.perUnit",me=M.attributes.price,he=Object(S.f)(c,me),je="".concat(he," ").concat(c.formatMessage({id:pe})),ke=!(_&&_.attributes.lastTransition===N.g),fe=d&&d.attributes?"".concat(d.attributes.profile.firstName," ").concat(d.attributes.profile.lastName):null,Pe=b&&ae.includes(b.status),Oe={name:fe};return Object(ee.jsxs)(T.Kb,r()(r()({},z),{},{children:[U,Object(ee.jsxs)("div",{className:$.a.contentContainer,children:[Object(ee.jsx)("div",{className:$.a.aspectWrapper,children:Object(ee.jsx)(T.Tb,{rootClassName:$.a.rootForImage,alt:F,image:Q,variants:["landscape-crop","landscape-crop2x"]})}),Object(ee.jsx)("div",{className:O()($.a.avatarWrapper,$.a.avatarMobile),children:Object(ee.jsx)(T.e,{user:A,disableProfileLink:!0})}),Object(ee.jsxs)("div",{className:$.a.bookListingContainer,children:[Object(ee.jsxs)("div",{className:$.a.heading,children:[Object(ee.jsx)("h1",{className:$.a.title,children:L}),Object(ee.jsx)("div",{className:$.a.author,children:Object(ee.jsx)(k.b,{id:"CheckoutPage.hostedBy",values:{name:A.attributes.profile.displayName}})})]}),Object(ee.jsxs)("div",{className:$.a.priceBreakdownContainer,children:[le,J]}),Object(ee.jsxs)("section",{className:$.a.paymentContainer,children:[oe,se,de,g?Object(ee.jsx)("p",{className:$.a.orderError,children:Object(ee.jsx)(k.b,{id:"CheckoutPage.retrievingStripePaymentIntentFailed",values:{listingLink:X}})}):null,G?Object(ee.jsx)(w.z,{className:$.a.paymentForm,onSubmit:this.handleSubmit,inProgress:this.state.submitting,formId:"CheckoutPagePaymentForm",paymentInfo:c.formatMessage({id:"CheckoutPage.paymentInfo"}),authorDisplayName:A.attributes.profile.displayName,showInitialMessageInput:ke,initialValues:Oe,initiateOrderError:o,confirmCardPaymentError:u,confirmPaymentError:s,hasHandledCardPayment:Pe,loadingData:!p,defaultPaymentMethod:K?d.stripeCustomer.defaultPaymentMethod:null,paymentIntent:b,onStripeInitialized:this.onStripeInitialized}):null,q?Object(ee.jsx)("p",{className:$.a.orderError,children:Object(ee.jsx)(k.b,{id:"CheckoutPage.paymentExpiredMessage",values:{listingLink:X}})}):null]})]}),Object(ee.jsxs)("div",{className:$.a.detailsContainerDesktop,children:[Object(ee.jsx)("div",{className:$.a.detailsAspectWrapper,children:Object(ee.jsx)(T.Tb,{rootClassName:$.a.rootForImage,alt:F,image:Q,variants:["landscape-crop","landscape-crop2x"]})}),Object(ee.jsx)("div",{className:$.a.avatarWrapper,children:Object(ee.jsx)(T.e,{user:A,disableProfileLink:!0})}),Object(ee.jsxs)("div",{className:$.a.detailsHeadings,children:[Object(ee.jsx)("h2",{className:$.a.detailsTitle,children:F}),Object(ee.jsx)("p",{className:$.a.detailsSubtitle,children:je})]}),le,J]})]})]}))}}]),a}(m.Component);oe.defaultProps={initiateOrderError:null,confirmPaymentError:null,listing:null,bookingData:{},bookingDates:null,speculateTransactionError:null,speculatedTransaction:null,transaction:null,currentUser:null,paymentIntent:null};var se=Object(h.compose)(f.withRouter,Object(j.connect)((function(e){var t=e.CheckoutPage,a=t.listing,n=t.bookingData,r=t.bookingDates,i=t.stripeCustomerFetched,o=t.speculateTransactionInProgress,s=t.speculateTransactionError,c=t.speculatedTransaction,l=t.transaction,d=t.initiateOrderError,u=t.confirmPaymentError,b=e.user.currentUser,g=e.stripe,p=g.confirmCardPaymentError,m=g.paymentIntent,h=g.retrievePaymentIntentError;return{scrollingDisabled:Object(M.b)(e),currentUser:b,stripeCustomerFetched:i,bookingData:n,bookingDates:r,speculateTransactionInProgress:o,speculateTransactionError:s,speculatedTransaction:c,transaction:l,listing:a,initiateOrderError:d,confirmCardPaymentError:p,confirmPaymentError:u,paymentIntent:m,retrievePaymentIntentError:h}}),(function(e){return{dispatch:e,fetchSpeculatedTransaction:function(t,a){return e(Object(L.f)(t,a))},fetchStripeCustomer:function(){return e(Object(L.g)())},onInitiateOrder:function(t,a){return e(Object(L.c)(t,a))},onRetrievePaymentIntent:function(t){return e(Object(A.e)(t))},onConfirmCardPayment:function(t){return e(Object(A.a)(t))},onConfirmPayment:function(t){return e(Object(L.a)(t))},onSendMessage:function(t){return e(Object(L.d)(t))},onSavePaymentMethod:function(t,a){return e(Object(F.c)(t,a))}}})),k.d)(oe);se.setInitialValues=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(t){var a=e.listing,n=e.bookingData,r=e.bookingDates;Q(n,r,a,null,te)}return Object(L.e)(e)},se.displayName="CheckoutPage";t.default=se},466:function(e,t,a){e.exports={topbar:"CheckoutPage_topbar__1zpY4",home:"CheckoutPage_home__2r1iY",logoMobile:"CheckoutPage_logoMobile__3tTtw",logoDesktop:"CheckoutPage_logoDesktop__3vNdq",contentContainer:"CheckoutPage_contentContainer__2e9aD",bookListingContainer:"CheckoutPage_bookListingContainer__G2qY_",aspectWrapper:"CheckoutPage_aspectWrapper__EUNTH",rootForImage:"CheckoutPage_rootForImage__PyyiQ",avatarWrapper:"CheckoutPage_avatarWrapper__1c4UD",avatarMobile:"CheckoutPage_avatarMobile__dW-28",heading:"CheckoutPage_heading__Wmk_3",title:"CheckoutPage_title__DKpNd",author:"CheckoutPage_author__ws2XJ",priceBreakdownContainer:"CheckoutPage_priceBreakdownContainer__1vQmV",priceBreakdownTitle:"CheckoutPage_priceBreakdownTitle__2AzWv",paymentContainer:"CheckoutPage_paymentContainer__1PxFQ",orderError:"CheckoutPage_orderError__2WKny",notFoundError:"CheckoutPage_notFoundError__1gqCg",speculateError:"CheckoutPage_speculateError__26a6-",paymentForm:"CheckoutPage_paymentForm__3wI8C",detailsContainerDesktop:"CheckoutPage_detailsContainerDesktop__XPaXD",detailsAspectWrapper:"CheckoutPage_detailsAspectWrapper__OwnB1",detailsHeadings:"CheckoutPage_detailsHeadings__1zRBN",detailsTitle:"CheckoutPage_detailsTitle__3rfU8",detailsSubtitle:"CheckoutPage_detailsSubtitle__2RTY5",bookingBreakdownTitle:"CheckoutPage_bookingBreakdownTitle__2tV27",bookingBreakdown:"CheckoutPage_bookingBreakdown__pzZRH"}}};
//# sourceMappingURL=CheckoutPage.b09b0fab.chunk.js.map