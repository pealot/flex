(this.__LOADABLE_LOADED_CHUNKS__=this.__LOADABLE_LOADED_CHUNKS__||[]).push([[2],{1117:function(e,t,a){e.exports={topbar:"CheckoutPage_topbar__1zpY4",home:"CheckoutPage_home__2r1iY",logoMobile:"CheckoutPage_logoMobile__3tTtw",logoDesktop:"CheckoutPage_logoDesktop__3vNdq",contentContainer:"CheckoutPage_contentContainer__2e9aD",bookListingContainer:"CheckoutPage_bookListingContainer__G2qY_",aspectWrapper:"CheckoutPage_aspectWrapper__EUNTH",rootForImage:"CheckoutPage_rootForImage__PyyiQ",avatarWrapper:"CheckoutPage_avatarWrapper__1c4UD",avatarMobile:"CheckoutPage_avatarMobile__dW-28",heading:"CheckoutPage_heading__Wmk_3",title:"CheckoutPage_title__DKpNd",author:"CheckoutPage_author__ws2XJ",priceBreakdownContainer:"CheckoutPage_priceBreakdownContainer__1vQmV",priceBreakdownTitle:"CheckoutPage_priceBreakdownTitle__2AzWv",paymentContainer:"CheckoutPage_paymentContainer__1PxFQ",orderError:"CheckoutPage_orderError__2WKny",notFoundError:"CheckoutPage_notFoundError__1gqCg",speculateError:"CheckoutPage_speculateError__26a6-",paymentForm:"CheckoutPage_paymentForm__3wI8C",detailsContainerDesktop:"CheckoutPage_detailsContainerDesktop__XPaXD",detailsAspectWrapper:"CheckoutPage_detailsAspectWrapper__OwnB1",detailsHeadings:"CheckoutPage_detailsHeadings__1zRBN",detailsTitle:"CheckoutPage_detailsTitle__3rfU8",detailsSubtitle:"CheckoutPage_detailsSubtitle__2RTY5",bookingBreakdownTitle:"CheckoutPage_bookingBreakdownTitle__2tV27",bookingBreakdown:"CheckoutPage_bookingBreakdown__pzZRH"}},1169:function(e,t,a){"use strict";a.r(t),a.d(t,"CheckoutPageComponent",(function(){return $}));var n=a(1),r=a(11),i=a(12),o=a(7),s=a(14),c=a(13),l=a(3),d=a(24),u=a(134),b=a(4),g=a(59),p=a(5),m=a.n(p),j=a(9),h=a(34),O=a(37),k=a(10),f=a(15),P=a(28),y=a(27),_=a(18),C=a(26),v=a(22),D=a(6),I=a(41),E=a(176),S=a(440),x=a(290),N=a(313),T=a(75),w=a(17),M=a.n(w),A=a(328),L=a.n(A),F=a(68),U=a.n(F),z=a(25),B=z.c.UUID,W=z.c.Money,H=function(e,t){return L()(Object.entries(t),(function(t,a){var n=Object(T.a)(a,2),r=n[0],i=n[1];return!(!Object.prototype.hasOwnProperty.call(e,r)||!i(e[r]))&&t}),!0)},R=function(e,t,a,n,r){if(window&&window.sessionStorage&&a&&t&&e){var i={bookingData:e,bookingDates:t,listing:a,transaction:n,storedAt:new Date},o=JSON.stringify(i,(function(e,t){return this[e]instanceof Date?{date:t,_serializedType:"SerializableDate"}:this[e]instanceof U.a?{decimal:t,_serializedType:"SerializableDecimal"}:z.c.replacer(e,t)}));window.sessionStorage.setItem(r,o)}},V=function(e){if(window&&window.sessionStorage){var t=window.sessionStorage.getItem(e),a=t?JSON.parse(t,(function(e,t){return t&&"object"===typeof t&&"SerializableDate"===t._serializedType?new Date(t.date):t&&"object"===typeof t&&"SerializableDecimal"===t._serializedType?new U.a(t.decimal):z.c.reviver(e,t)})):{},n=a.bookingData,r=a.bookingDates,i=a.listing,o=a.transaction,s=a.storedAt,c=!!s&&M()(s).isAfter(M()().subtract(1,"days")),l=!o||function(e){return H(e,{id:function(e){return e instanceof B},type:function(e){return"transaction"===e},attributes:function(e){return"object"===typeof e&&v.a.includes(e.lastTransition)}})}(o),d=c&&function(e){return H(e,{bookingStart:function(e){return e instanceof Date},bookingEnd:function(e){return e instanceof Date}})}(r)&&function(e){return H(e,{id:function(e){return e instanceof B},attributes:function(e){return"object"===typeof e&&e.price instanceof W}})}(i)&&l;if(d)return{bookingData:n,bookingDates:r,listing:i,transaction:o}}return{}},K=a(1117),Y=a.n(K),J=a(0),q="CheckoutPage",G=["processing","requires_capture","succeeded"],Q="PAY_AND_SAVE_FOR_LATER_USE",X="USE_SAVED_CARD",Z=function(e){return!!Object(v.I)(e)||!!Object(v.J)(e)&&Object(P.k)(e.attributes.lastTransitionedAt,new Date)>=15},$=function(e){Object(s.a)(a,e);var t=Object(c.a)(a);function a(e){var n;return Object(r.a)(this,a),(n=t.call(this,e)).state={pageData:{},dataLoaded:!1,submitting:!1},n.stripe=null,n.onStripeInitialized=n.onStripeInitialized.bind(Object(o.a)(n)),n.loadInitialData=n.loadInitialData.bind(Object(o.a)(n)),n.handlePaymentIntent=n.handlePaymentIntent.bind(Object(o.a)(n)),n.handleSubmit=n.handleSubmit.bind(Object(o.a)(n)),n}return Object(i.a)(a,[{key:"componentDidMount",value:function(){window&&this.loadInitialData()}},{key:"loadInitialData",value:function(){var e=this.props,t=e.bookingData,a=e.bookingDates,n=e.listing,r=e.transaction,i=e.fetchSpeculatedTransaction,o=e.fetchStripeCustomer,s=e.history;o();var c="PUSH"===s.action||"REPLACE"===s.action,l=!!(t&&a&&n)&&c;l&&R(t,a,n,r,q);var d=l?{bookingData:t,bookingDates:a,listing:n,transaction:r}:V(q),u=d?d.transaction:null,b=u&&u.booking&&u.booking.id;if(d&&d.listing&&d.listing.id&&d.bookingData&&d.bookingDates&&d.bookingDates.bookingStart&&d.bookingDates.bookingEnd&&!b){var g=d.listing.id,p=u?u.id:null,m=d.bookingDates,j=m.bookingStart,h=m.bookingEnd;i({listingId:g,bookingStart:Object(P.d)(j),bookingEnd:Object(P.d)(h)},p)}this.setState({pageData:d||{},dataLoaded:!0})}},{key:"handlePaymentIntent",value:function(e){var t=this,a=this.props,r=a.currentUser,i=a.stripeCustomerFetched,o=a.onInitiateOrder,s=a.onConfirmCardPayment,c=a.onConfirmPayment,l=a.onSendMessage,d=a.onSavePaymentMethod,u=e.pageData,b=e.speculatedTransaction,g=e.message,p=e.paymentIntent,m=e.selectedPaymentMethod,j=e.saveAfterOnetimePayment,h=Object(f.l)(u.transaction),O=Object(f.e)(r),k=Object(f.j)(O.stripeCustomer),P=Object(f.i)(k.defaultPaymentMethod),y=null,_=!!(i&&k.attributes.stripeCustomerId&&P.id),C=_?P.attributes.stripePaymentMethodId:null,v=function(e,t){return"defaultCard"===e?X:t?Q:"ONETIME_PAYMENT"}(m,j),D=function(e,t){return e.then(t)},I=function(){for(var e=arguments.length,t=new Array(e),a=0;a<e;a++)t[a]=arguments[a];return function(e){return t.reduce(D,Promise.resolve(e))}}((function(e){return h.attributes.protectedData&&h.attributes.protectedData.stripePaymentIntents?Promise.resolve(h):o(e,h.id)}),(function(a){var r=Object(f.l)(a);if(r.id){var i=u.bookingData,o=u.bookingDates,c=u.listing;R(i,o,c,r,q),t.setState({pageData:Object(n.a)(Object(n.a)({},u),{},{transaction:r})})}var l=r.attributes.protectedData&&r.attributes.protectedData.stripePaymentIntents;if(!l)throw new Error("Missing StripePaymentIntents key in transaction's protectedData. Check that your transaction process is configured to use payment intents.");var d=(l?r.attributes.protectedData.stripePaymentIntents.default:null).stripePaymentIntentClientSecret,b=e.stripe,g=e.card,p=e.billingDetails,m=e.paymentIntent,j=v!==X?{card:g}:{},h=v!==X?{payment_method:{billing_details:p,card:g}}:{},O=Object(n.a)(Object(n.a)({stripePaymentIntentClientSecret:d,orderId:r.id,stripe:b},j),{},{paymentParams:h});return m&&G.includes(m.status)?Promise.resolve({transactionId:r.id,paymentIntent:m}):s(O)}),(function(e){return y=e.paymentIntent,c(e)}),(function(e){return l(Object(n.a)(Object(n.a)({},e),{},{message:g}))}),(function(e){return v===Q?d(k,(y||p).payment_method).then((function(t){return t.errors?Object(n.a)(Object(n.a)({},e),{},{paymentMethodSaved:!1}):Object(n.a)(Object(n.a)({},e),{},{paymentMethodSaved:!0})})).catch((function(t){return Object(n.a)(Object(n.a)({},e),{},{paymentMethodSaved:!1})})):Promise.resolve(Object(n.a)(Object(n.a)({},e),{},{paymentMethodSaved:!0}))})),E=b||h,S=v===X&&_?{paymentMethod:C}:v===Q?{setupPaymentMethodForSaving:!0}:{};return I(Object(n.a)({listingId:u.listing.id,bookingStart:E.booking.attributes.start,bookingEnd:E.booking.attributes.end},S))}},{key:"handleSubmit",value:function(e){var t=this;if(!this.state.submitting){this.setState({submitting:!0});var a=this.props,r=a.history,i=a.speculatedTransaction,o=a.currentUser,s=a.paymentIntent,c=a.dispatch,l=e.card,d=e.message,u=e.paymentMethod,b=e.formValues,g=b.name,p=b.addressLine1,m=b.addressLine2,j=b.postal,k=b.city,P=b.state,y=b.country,_=b.saveAfterOnetimePayment,C=p&&j?{address:{city:k,country:y,line1:p,line2:m,postal_code:j,state:P}}:{},v=Object(n.a)({name:g,email:Object(f.e)(o).attributes.email},C),D={pageData:this.state.pageData,speculatedTransaction:i,stripe:this.stripe,card:l,billingDetails:v,message:d,paymentIntent:s,selectedPaymentMethod:u,saveAfterOnetimePayment:!!_};this.handlePaymentIntent(D).then((function(e){var a=e.orderId,n=e.messageSuccess,i=e.paymentMethodSaved;t.setState({submitting:!1});var o,s=Object(h.b)(),l=n?null:a,d=Object(O.e)("OrderDetailsPage",s,{id:a.uuid});!function(e,t,a){a(Object(O.c)("OrderDetailsPage",t).setInitialValues(e))}({initialMessageFailedToTransaction:l,savePaymentMethodFailed:!i},s,c),o=q,window&&window.sessionStorage&&window.sessionStorage.removeItem(o),r.push(d)})).catch((function(e){console.error(e),t.setState({submitting:!1})}))}}},{key:"onStripeInitialized",value:function(e){this.stripe=e;var t=this.props,a=t.paymentIntent,n=t.onRetrievePaymentIntent,r=this.state.pageData?this.state.pageData.transaction:null;this.stripe&&!a&&r&&r.id&&r.booking&&r.booking.id&&Object(v.J)(r)&&!Z(r)&&n({stripe:e,stripePaymentIntentClientSecret:(r.attributes.protectedData&&r.attributes.protectedData.stripePaymentIntents?r.attributes.protectedData.stripePaymentIntents.default:{}).stripePaymentIntentClientSecret})}},{key:"render",value:function(){var e=this.props,t=e.scrollingDisabled,a=e.speculateTransactionInProgress,r=e.speculateTransactionError,i=e.speculatedTransaction,o=e.initiateOrderError,s=e.confirmPaymentError,c=e.intl,l=e.params,d=e.currentUser,u=e.confirmCardPaymentError,g=e.paymentIntent,p=e.retrievePaymentIntentError,h=e.stripeCustomerFetched,O=Object(_.k)(r)||Object(_.k)(o),P=!this.state.dataLoaded||a,E=this.state.pageData,S=E.listing,x=E.bookingDates,N=E.transaction,T=Object(f.l)(N),w=Object(f.l)(i,{},null),M=Object(f.g)(S),A=Object(f.m)(M.author),L=M.attributes.title,F=c.formatMessage({id:"CheckoutPage.title"},{listingTitle:L}),U={title:F,scrollingDisabled:t},z=Object(J.jsx)("div",{className:Y.a.topbar,children:Object(J.jsxs)(D.Gb,{className:Y.a.home,name:"LandingPage",children:[Object(J.jsx)(D.wb,{className:Y.a.logoMobile,title:c.formatMessage({id:"CheckoutPage.goToLandingPage"}),format:"mobile"}),Object(J.jsx)(D.wb,{className:Y.a.logoDesktop,alt:c.formatMessage({id:"CheckoutPage.goToLandingPage"}),format:"desktop"})]})});if(P)return Object(J.jsx)(D.Kb,Object(n.a)(Object(n.a)({},U),{},{children:z}));var B=d&&d.id&&A&&A.id&&A.id.uuid===d.id.uuid,W=!(!M.id||!A.id),H=!!(x&&x.bookingStart&&x.bookingEnd),R=W&&H;if(!P&&!(R&&!B))return console.error("Missing or invalid data for checkout, redirecting back to listing page.",{transaction:w,bookingDates:x,listing:S}),Object(J.jsx)(D.Hb,{name:"ListingPage",params:l});var V=T.booking?T:w,K=Object(f.d)(V.booking),q=V.id&&K.id?Object(J.jsx)(D.f,{className:Y.a.bookingBreakdown,userRole:"customer",unitType:j.a.bookingUnitType,transaction:V,booking:K,dateType:k.a}):null,Q=Z(T),X=!!(h&&Object(f.j)(d.stripeCustomer).attributes.stripeCustomerId&&Object(f.i)(d.stripeCustomer.defaultPaymentMethod).id),$=!(!d||!R||O||o||r||p||Q),ee=M.images&&M.images.length>0?M.images[0]:null,te=Object(J.jsx)(D.Gb,{name:"ListingPage",params:{id:M.id.uuid,slug:Object(y.f)(L)},children:Object(J.jsx)(b.b,{id:"CheckoutPage.errorlistingLinkText"})}),ae=Object(_.i)(o),ne=Object(_.h)(o),re=Object(_.j)(o),ie=Object(_.s)(o),oe=null,se=null;if(O)se=Object(J.jsx)("p",{className:Y.a.notFoundError,children:Object(J.jsx)(b.b,{id:"CheckoutPage.listingNotFoundError"})});else if(ae)oe=Object(J.jsx)("p",{className:Y.a.orderError,children:Object(J.jsx)(b.b,{id:"CheckoutPage.initiateOrderAmountTooLow"})});else if(re)oe=Object(J.jsx)("p",{className:Y.a.orderError,children:Object(J.jsx)(b.b,{id:"CheckoutPage.bookingTimeNotAvailableMessage"})});else if(ne)oe=Object(J.jsx)("p",{className:Y.a.orderError,children:Object(J.jsx)(b.b,{id:"CheckoutPage.chargeDisabledMessage"})});else if(ie&&ie.length>0){var ce=ie.join(", ");oe=Object(J.jsx)("p",{className:Y.a.orderError,children:Object(J.jsx)(b.b,{id:"CheckoutPage.initiateOrderStripeError",values:{stripeErrors:ce}})})}else o&&(oe=Object(J.jsx)("p",{className:Y.a.orderError,children:Object(J.jsx)(b.b,{id:"CheckoutPage.initiateOrderError",values:{listingLink:te}})}));var le=r?Object(J.jsx)("p",{className:Y.a.speculateError,children:Object(J.jsx)(b.b,{id:"CheckoutPage.speculateTransactionError"})}):null,de=null;Object(_.l)(r)?de=Object(J.jsx)("p",{className:Y.a.orderError,children:Object(J.jsx)(b.b,{id:"CheckoutPage.providerStripeAccountMissingError"})}):Object(_.j)(r)?de=Object(J.jsx)("p",{className:Y.a.orderError,children:Object(J.jsx)(b.b,{id:"CheckoutPage.bookingTimeNotAvailableMessage"})}):Object(_.m)(r)?de=Object(J.jsx)("p",{className:Y.a.orderError,children:Object(J.jsx)(b.b,{id:"CheckoutPage.initiateOrderAmountTooLow"})}):r&&(de=Object(J.jsx)("p",{className:Y.a.orderError,children:Object(J.jsx)(b.b,{id:"CheckoutPage.speculateFailedMessage"})}));var ue=j.a.bookingUnitType,be=ue===k.s,ge=ue===k.r,pe=be?"CheckoutPage.perNight":ge?"CheckoutPage.perDay":"CheckoutPage.perUnit",me=M.attributes.price,je=Object(C.f)(c,me),he="".concat(je," ").concat(c.formatMessage({id:pe})),Oe=!(T&&T.attributes.lastTransition===v.g),ke=d&&d.attributes?"".concat(d.attributes.profile.firstName," ").concat(d.attributes.profile.lastName):null,fe=g&&G.includes(g.status),Pe={name:ke};return Object(J.jsxs)(D.Kb,Object(n.a)(Object(n.a)({},U),{},{children:[z,Object(J.jsxs)("div",{className:Y.a.contentContainer,children:[Object(J.jsx)("div",{className:Y.a.aspectWrapper,children:Object(J.jsx)(D.Tb,{rootClassName:Y.a.rootForImage,alt:L,image:ee,variants:["landscape-crop","landscape-crop2x"]})}),Object(J.jsx)("div",{className:m()(Y.a.avatarWrapper,Y.a.avatarMobile),children:Object(J.jsx)(D.e,{user:A,disableProfileLink:!0})}),Object(J.jsxs)("div",{className:Y.a.bookListingContainer,children:[Object(J.jsxs)("div",{className:Y.a.heading,children:[Object(J.jsx)("h1",{className:Y.a.title,children:F}),Object(J.jsx)("div",{className:Y.a.author,children:Object(J.jsx)(b.b,{id:"CheckoutPage.hostedBy",values:{name:A.attributes.profile.displayName}})})]}),Object(J.jsxs)("div",{className:Y.a.priceBreakdownContainer,children:[le,q]}),Object(J.jsxs)("section",{className:Y.a.paymentContainer,children:[oe,se,de,p?Object(J.jsx)("p",{className:Y.a.orderError,children:Object(J.jsx)(b.b,{id:"CheckoutPage.retrievingStripePaymentIntentFailed",values:{listingLink:te}})}):null,$?Object(J.jsx)(I.z,{className:Y.a.paymentForm,onSubmit:this.handleSubmit,inProgress:this.state.submitting,formId:"CheckoutPagePaymentForm",paymentInfo:c.formatMessage({id:"CheckoutPage.paymentInfo"}),authorDisplayName:A.attributes.profile.displayName,showInitialMessageInput:Oe,initialValues:Pe,initiateOrderError:o,confirmCardPaymentError:u,confirmPaymentError:s,hasHandledCardPayment:fe,loadingData:!h,defaultPaymentMethod:X?d.stripeCustomer.defaultPaymentMethod:null,paymentIntent:g,onStripeInitialized:this.onStripeInitialized}):null,Q?Object(J.jsx)("p",{className:Y.a.orderError,children:Object(J.jsx)(b.b,{id:"CheckoutPage.paymentExpiredMessage",values:{listingLink:te}})}):null]})]}),Object(J.jsxs)("div",{className:Y.a.detailsContainerDesktop,children:[Object(J.jsx)("div",{className:Y.a.detailsAspectWrapper,children:Object(J.jsx)(D.Tb,{rootClassName:Y.a.rootForImage,alt:L,image:ee,variants:["landscape-crop","landscape-crop2x"]})}),Object(J.jsx)("div",{className:Y.a.avatarWrapper,children:Object(J.jsx)(D.e,{user:A,disableProfileLink:!0})}),Object(J.jsxs)("div",{className:Y.a.detailsHeadings,children:[Object(J.jsx)("h2",{className:Y.a.detailsTitle,children:L}),Object(J.jsx)("p",{className:Y.a.detailsSubtitle,children:he})]}),le,q]})]})]}))}}]),a}(l.Component);$.defaultProps={initiateOrderError:null,confirmPaymentError:null,listing:null,bookingData:{},bookingDates:null,speculateTransactionError:null,speculatedTransaction:null,transaction:null,currentUser:null,paymentIntent:null};var ee=Object(d.c)(g.h,Object(u.b)((function(e){var t=e.CheckoutPage,a=t.listing,n=t.bookingData,r=t.bookingDates,i=t.stripeCustomerFetched,o=t.speculateTransactionInProgress,s=t.speculateTransactionError,c=t.speculatedTransaction,l=t.transaction,d=t.initiateOrderError,u=t.confirmPaymentError,b=e.user.currentUser,g=e.stripe,p=g.confirmCardPaymentError,m=g.paymentIntent,j=g.retrievePaymentIntentError;return{scrollingDisabled:Object(E.b)(e),currentUser:b,stripeCustomerFetched:i,bookingData:n,bookingDates:r,speculateTransactionInProgress:o,speculateTransactionError:s,speculatedTransaction:c,transaction:l,listing:a,initiateOrderError:d,confirmCardPaymentError:p,confirmPaymentError:u,paymentIntent:m,retrievePaymentIntentError:j}}),(function(e){return{dispatch:e,fetchSpeculatedTransaction:function(t,a){return e(Object(N.f)(t,a))},fetchStripeCustomer:function(){return e(Object(N.g)())},onInitiateOrder:function(t,a){return e(Object(N.c)(t,a))},onRetrievePaymentIntent:function(t){return e(Object(S.e)(t))},onConfirmCardPayment:function(t){return e(Object(S.a)(t))},onConfirmPayment:function(t){return e(Object(N.a)(t))},onSendMessage:function(t){return e(Object(N.d)(t))},onSavePaymentMethod:function(t,a){return e(Object(x.c)(t,a))}}})),b.d)($);ee.setInitialValues=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(t){var a=e.listing,n=e.bookingData,r=e.bookingDates;R(n,r,a,null,q)}return Object(N.e)(e)},ee.displayName="CheckoutPage";t.default=ee}}]);
//# sourceMappingURL=CheckoutPage.c24f56e7.chunk.js.map